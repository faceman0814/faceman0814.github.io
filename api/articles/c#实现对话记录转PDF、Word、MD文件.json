{"title":"c#实现对话记录转PDF、Word、MD文件","uid":"d153e7aca8864e461d50ee65cfb7c4b4","slug":"c#实现对话记录转PDF、Word、MD文件","date":"2024-11-19T00:00:00.000Z","updated":"2024-12-24T01:56:35.265Z","comments":true,"path":"api/articles/c#实现对话记录转PDF、Word、MD文件.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/esmeralda.2krxt9cbnx.webp","content":"<p>工作中有个场景是chatgpt聊天对话记录下载支持PDF、Word、MD格式，于是有了本篇文章。</p>\n<h1 id=\"实现思路\"><a href=\"#实现思路\" class=\"headerlink\" title=\"实现思路\"></a>实现思路</h1><p>对话中可能会用md格式的回答，且因为不能直接转成pdf或者word，所以这里通过方法转成md或者html代码，使用html格式转成pdf或者word。</p>\n<h1 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h1><h2 id=\"需要的nuget包\"><a href=\"#需要的nuget包\" class=\"headerlink\" title=\"需要的nuget包\"></a>需要的nuget包</h2><ul>\n<li>html转pdf<br>iTextSharp<br>itextsharp.xmlworker</li>\n<li>html转word<br>FreeSpire.Doc</li>\n<li>md转html<br>Markdig</li>\n</ul>\n<h2 id=\"创建HtmlHelper帮助类\"><a href=\"#创建HtmlHelper帮助类\" class=\"headerlink\" title=\"创建HtmlHelper帮助类\"></a>创建HtmlHelper帮助类</h2><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> HTML帮助类</span></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">HtmlHelper</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\">\t<span class=\"comment\"><span class=\"doctag\">///</span> 字体路径</span></span><br><span class=\"line\">\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"built_in\">string</span> FontPath;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HtmlHelper</span>(<span class=\"params\"><span class=\"built_in\">string</span> fontPath</span>)</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tFontPath = fontPath;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HtmlHelper</span>()</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//将html字符串转为pdf字节数组</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"built_in\">byte</span>[] <span class=\"title\">ConvertHtmlTextToPDF</span>(<span class=\"params\"><span class=\"built_in\">string</span> htmlText</span>)</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">string</span>.IsNullOrEmpty(htmlText))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tMemoryStream outputStream = <span class=\"keyword\">new</span> MemoryStream(); <span class=\"comment\">//要把PDF寫到哪個串流</span></span><br><span class=\"line\">\t\t\t<span class=\"built_in\">byte</span>[] data = Encoding.UTF8.GetBytes(htmlText); <span class=\"comment\">//字串轉成byte[]</span></span><br><span class=\"line\">\t\t\tMemoryStream msInput = <span class=\"keyword\">new</span> MemoryStream(data);</span><br><span class=\"line\">\t\t\tDocument doc = <span class=\"keyword\">new</span> Document(); <span class=\"comment\">//要寫PDF的文件，建構子沒填的話預設直式A4</span></span><br><span class=\"line\">\t\t\tPdfWriter writer = PdfWriter.GetInstance(doc, outputStream);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//指定文件預設開檔時的縮放為100%</span></span><br><span class=\"line\">\t\t\tPdfDestination pdfDest = <span class=\"keyword\">new</span> PdfDestination(PdfDestination.XYZ, <span class=\"number\">0</span>, doc.PageSize.Height, <span class=\"number\">1f</span>);</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//開啟Document文件 </span></span><br><span class=\"line\">\t\t\tdoc.Open();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//使用XMLWorkerHelper把Html parse到PDF檔裡</span></span><br><span class=\"line\">\t\t\tXMLWorkerHelper.GetInstance().ParseXHtml(writer, doc, msInput, <span class=\"literal\">null</span>, Encoding.UTF8, <span class=\"keyword\">new</span> UnicodeFontFactory());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//將pdfDest設定的資料寫到PDF檔</span></span><br><span class=\"line\">\t\t\tPdfAction action = PdfAction.GotoLocalPage(<span class=\"number\">1</span>, pdfDest, writer);</span><br><span class=\"line\">\t\t\twriter.SetOpenAction(action);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tdoc.Close();</span><br><span class=\"line\">\t\t\tmsInput.Close();</span><br><span class=\"line\">\t\t\toutputStream.Close();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> outputStream.ToArray();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Exception ex)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> UserFriendlyException(<span class=\"string\">&quot;转PDF时异常,请联系管理员！&quot;</span>, ex);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//将html字符串转为word字节数组</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"built_in\">byte</span>[] <span class=\"title\">ConvertHtmlTextToWord</span>(<span class=\"params\"><span class=\"built_in\">string</span> htmlText</span>)</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">string</span>.IsNullOrEmpty(htmlText))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tMemoryStream outputStream = <span class=\"keyword\">new</span> MemoryStream(); <span class=\"comment\">//要把Word寫到哪個串流</span></span><br><span class=\"line\">\t\t\t<span class=\"built_in\">byte</span>[] data = Encoding.UTF8.GetBytes(htmlText); <span class=\"comment\">//字串轉成byte[]</span></span><br><span class=\"line\">\t\t\tMemoryStream  stream = <span class=\"keyword\">new</span> MemoryStream(data);</span><br><span class=\"line\">\t\t\tSpire.Doc.Document doc = <span class=\"keyword\">new</span> Spire.Doc.Document(); <span class=\"comment\">//要寫Word的文件，建構子沒填的話預設直式A4</span></span><br><span class=\"line\">\t\t\tdoc.LoadFromStream(stream, FileFormat.Html, XHTMLValidationType.None);</span><br><span class=\"line\">\t\t\tdoc.SaveToStream(outputStream, FileFormat.Docx);</span><br><span class=\"line\">\t\t\tdoc.Close();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> outputStream.ToArray();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Exception ex)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> UserFriendlyException(<span class=\"string\">&quot;转Word时异常,请联系管理员！&quot;</span>, ex);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//字体工厂</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">UnicodeFontFactory</span> : <span class=\"title\">FontFactoryImp</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> Font <span class=\"title\">GetFont</span>(<span class=\"params\"><span class=\"built_in\">string</span> fontname, <span class=\"built_in\">string</span> encoding, <span class=\"built_in\">bool</span> embedded, <span class=\"built_in\">float</span> size, <span class=\"built_in\">int</span> style, BaseColor color,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t<span class=\"built_in\">bool</span> cached</span>)</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tBaseFont baseFont = BaseFont.CreateFont(FontPath, BaseFont.IDENTITY_H, BaseFont.EMBEDDED);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Font(baseFont, size, style, color);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"创建测试信息类\"><a href=\"#创建测试信息类\" class=\"headerlink\" title=\"创建测试信息类\"></a>创建测试信息类</h2><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Message</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Type &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Context &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"通过控制器调用。\"><a href=\"#通过控制器调用。\" class=\"headerlink\" title=\"通过控制器调用。\"></a>通过控制器调用。</h2><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">FileController</span>：<span class=\"title\">Controller</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IHttpContextAccessor _httpContextAccessor;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">FileController</span>(<span class=\"params\">IHttpContextAccessor httpContextAccessor）</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t&#123;</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t_httpContextAccessor=httpContextAccessor;</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t&#125;</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t/// &lt;summary&gt;</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t/// 导出当前对话全部信息为Markdown</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t/// &lt;/summary&gt;</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t/// &lt;param name=<span class=\"string\">&quot;messageId&quot;</span>&gt;&lt;/param&gt;</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t/// &lt;returns&gt;&lt;/returns&gt;</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t[HttpGet]</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t[DisableAuditing]</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IActionResult&gt; GenerateAllMarkdown(</span>)</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> stringBuilder = <span class=\"keyword\">await</span> GenerateFile(<span class=\"string\">&quot;md&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">byte</span>[] markdownBytes = Encoding.UTF8.GetBytes(stringBuilder);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> fileName = <span class=\"string\">$&quot;文件名称-<span class=\"subst\">&#123;Clock.Now.ToString(<span class=\"string\">&quot;yyyyMMddHHmmss&quot;</span>)&#125;</span>.md&quot;</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> contentType = <span class=\"string\">&quot;text/markdown&quot;</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> File(markdownBytes, contentType, fileName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> 导出当前对话全部信息为Word</span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=&quot;messageId&quot;&gt;</span><span class=\"doctag\">&lt;/param&gt;</span></span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;returns&gt;</span><span class=\"doctag\">&lt;/returns&gt;</span></span></span><br><span class=\"line\">\t\t[<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">\t\t[<span class=\"meta\">DisableAuditing</span>]</span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;ActionResult&gt; <span class=\"title\">GenerateAllWord</span>()</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> stringBuilder = <span class=\"keyword\">await</span> GenerateFile(<span class=\"string\">&quot;html&quot;</span>);</span><br><span class=\"line\">\t\t\tHtmlHelper pdfHelper = <span class=\"keyword\">new</span> HtmlHelper();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> byteData = pdfHelper.ConvertHtmlTextToWord(stringBuilder);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> fileName = <span class=\"string\">$&quot;文件名称-<span class=\"subst\">&#123;Clock.Now.ToString(<span class=\"string\">&quot;yyyyMMddHHmmss&quot;</span>)&#125;</span>.docx&quot;</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> contentType = <span class=\"string\">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> File(byteData, contentType, fileName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> 导出当前对话全部信息为PDF</span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=&quot;chatId&quot;&gt;</span><span class=\"doctag\">&lt;/param&gt;</span></span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=&quot;chatUserId&quot;&gt;</span><span class=\"doctag\">&lt;/param&gt;</span></span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;returns&gt;</span><span class=\"doctag\">&lt;/returns&gt;</span></span></span><br><span class=\"line\">\t\t<span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;exception cref=&quot;UserFriendlyException&quot;&gt;</span><span class=\"doctag\">&lt;/exception&gt;</span></span></span><br><span class=\"line\">\t\t[<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">\t\t[<span class=\"meta\">DisableAuditing</span>]</span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;ActionResult&gt; <span class=\"title\">GeneratePDF</span>()</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t <span class=\"keyword\">var</span> stringBuilder = <span class=\"keyword\">await</span> GenerateFile(<span class=\"string\">&quot;html&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"built_in\">string</span> fontPath = Path.Combine(<span class=\"string\">&quot;字体地址&quot;</span>, <span class=\"string\">&quot;Nsimsun.ttf&quot;</span>);</span><br><span class=\"line\">\t\t\tHtmlHelper pdfHelper = <span class=\"keyword\">new</span> HtmlHelper(fontPath);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> byteData = pdfHelper.ConvertHtmlTextToPDF(stringBuilder);<span class=\"comment\">//生成PDF</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> fileName = <span class=\"string\">$&quot;文件名称-<span class=\"subst\">&#123;Clock.Now.ToString(<span class=\"string\">&quot;yyyyMMddHHmmss&quot;</span>)&#125;</span>.pdf&quot;</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> contentType = <span class=\"string\">&quot;application/pdf&quot;</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> File(byteData, contentType, fileName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">async</span> Task&lt;<span class=\"built_in\">string</span>&gt; <span class=\"title\">GenerateFile</span>(<span class=\"params\"><span class=\"built_in\">string</span> type</span>)</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> title = <span class=\"string\">&quot;我是标题&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> UserName = <span class=\"string\">&quot;我是用户&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> Url = <span class=\"string\">&quot;我是链接&quot;</span>;</span><br><span class=\"line\">\t\tList&lt;Message&gt; currentMessage = <span class=\"keyword\">new</span> List&lt;Message&gt;()</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">new</span> Message()</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tType =<span class=\"string\">&quot;user&quot;</span>,</span><br><span class=\"line\">\t\t\t\tContext=<span class=\"string\">&quot;你是谁&quot;</span></span><br><span class=\"line\">\t\t\t&#125;，</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">new</span> Message()</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tType =<span class=\"string\">&quot;bot&quot;</span>,</span><br><span class=\"line\">\t\t\t\tContext=<span class=\"string\">&quot;hello，我是chatgpt&quot;</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//...</span></span><br><span class=\"line\">\t\t&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//信息查询操作。。。。</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">string</span> stringBuilder = <span class=\"literal\">default</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">string</span> symbolA = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">string</span> symbolB = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> (type)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"string\">&quot;html&quot;</span>:</span><br><span class=\"line\">\t\t\t\tsymbolA = <span class=\"string\">&quot;&lt;strong&gt;&quot;</span>;</span><br><span class=\"line\">\t\t\t\tsymbolB = <span class=\"string\">&quot;&lt;/strong&gt;&quot;</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"string\">&quot;md&quot;</span>:</span><br><span class=\"line\">\t\t\t\tsymbolA = <span class=\"string\">&quot;**&quot;</span>;</span><br><span class=\"line\">\t\t\t\tsymbolB = <span class=\"string\">&quot;**&quot;</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">//设置标题</span></span><br><span class=\"line\">\t\tstringBuilder += <span class=\"string\">$&quot;# <span class=\"subst\">&#123;title&#125;</span> \\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> item <span class=\"keyword\">in</span> allMessages)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (item.Type == <span class=\"string\">&quot;bot&quot;</span>)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tstringBuilder += <span class=\"string\">$&quot;<span class=\"subst\">&#123;symbolA&#125;</span> AI回答：<span class=\"subst\">&#123;symbolB&#125;</span>  \\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tstringBuilder += <span class=\"string\">$&quot;<span class=\"subst\">&#123;symbolA&#125;</span> 用户提问：<span class=\"subst\">&#123;symbolB&#125;</span>  \\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tstringBuilder += <span class=\"string\">$&quot;<span class=\"subst\">&#123;item.Content&#125;</span> \\n&quot;</span>;</span><br><span class=\"line\">\t\t\tstringBuilder += <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> request = _httpContextAccessor.HttpContext.Request;</span><br><span class=\"line\">\t\t<span class=\"built_in\">string</span> fullUrl = <span class=\"string\">$&quot;<span class=\"subst\">&#123;request.Scheme&#125;</span>://<span class=\"subst\">&#123;request.Host&#125;</span>&quot;</span>;</span><br><span class=\"line\">\t\tstringBuilder += <span class=\"string\">$&quot;&gt; 编辑于 <span class=\"subst\">&#123;DateTime.Now&#125;</span>\\n &quot;</span> +</span><br><span class=\"line\">\t\t\t<span class=\"string\">$&quot;&gt;作者：<span class=\"subst\">&#123;UserName&#125;</span> \\n &quot;</span> +</span><br><span class=\"line\">\t\t\t<span class=\"string\">$&quot;&gt;链接：<span class=\"subst\">&#123;Url&#125;</span>\\n &quot;</span> +</span><br><span class=\"line\">\t\t\t<span class=\"string\">$&quot;&gt;来源：我是来源&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (type == <span class=\"string\">&quot;html&quot;</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tstringBuilder = Markdown.ToHtml(stringBuilder);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;/n&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt;&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;&lt;p&gt;&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;&lt;/p&gt;&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt;&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;AI回答：&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt; AI回答：&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;用户提问：&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt; 用户提问：&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;&lt;blockquote&gt;&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;&lt;/blockquote&gt;&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;编辑于：&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt;&lt;br /&gt; 编辑于：&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;作者：&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt; 作者：&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;链接：&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt; 链接：&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = stringBuilder.Replace(<span class=\"string\">&quot;来源：&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt; 来源：&quot;</span>);</span><br><span class=\"line\">\t\t\tstringBuilder = <span class=\"string\">$&quot;\\r\\n&lt;!DOCTYPE html&gt;\\r\\n&lt;html&gt;\\r\\n&lt;head&gt;\\r\\n    &lt;meta charset=\\&quot;utf-8\\&quot; /&gt;\\r\\n    &lt;title&gt;<span class=\"subst\">&#123;currentChat.Name&#125;</span>&lt;/title&gt;\\r\\n&lt;/head&gt;\\r\\n&lt;body&gt;\\r\\n&quot;</span> + stringBuilder;</span><br><span class=\"line\">\t\t\tstringBuilder += <span class=\"string\">&quot;\\r\\n&lt;/body&gt;\\r\\n&lt;/html&gt;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> stringBuilder;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","text":"工作中有个场景是chatgpt聊天对话记录下载支持PDF、Word、MD格式，于是有了本篇文章。 实现思路对话中可能会用md格式的回答，且因为不能直接转成pdf...","permalink":"/post/c#实现对话记录转PDF、Word、MD文件","photos":[],"count_time":{"symbolsCount":"8.7k","symbolsTime":"8 mins."},"categories":[{"name":".Net","slug":"Net","count":4,"path":"api/categories/Net.json"}],"tags":[{"name":"c#","slug":"c","count":2,"path":"api/tags/c.json"},{"name":".Net","slug":"Net","count":2,"path":"api/tags/Net.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF\"><span class=\"toc-text\">实现思路</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">代码实现</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%9C%80%E8%A6%81%E7%9A%84nuget%E5%8C%85\"><span class=\"toc-text\">需要的nuget包</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BAHtmlHelper%E5%B8%AE%E5%8A%A9%E7%B1%BB\"><span class=\"toc-text\">创建HtmlHelper帮助类</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E4%BF%A1%E6%81%AF%E7%B1%BB\"><span class=\"toc-text\">创建测试信息类</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%80%9A%E8%BF%87%E6%8E%A7%E5%88%B6%E5%99%A8%E8%B0%83%E7%94%A8%E3%80%82\"><span class=\"toc-text\">通过控制器调用。</span></a></li></ol></li></ol>","author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"NFS for CentOS","uid":"584404787b0b0e754117ced08ab7daf6","slug":"NFSforCentOS","date":"2024-11-19T00:00:00.000Z","updated":"2024-12-24T01:56:35.264Z","comments":true,"path":"api/articles/NFSforCentOS.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/docker.4g4ilvor9o.webp","text":"NFS for CentOSNFS介绍NFS介绍NFS 即网络文件系统（Network File-System），可以通过网络让不同机器、不同系统之间可以实现文...","permalink":"/post/NFSforCentOS","photos":[],"count_time":{"symbolsCount":"1.5k","symbolsTime":"1 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[{"name":"CentOS","slug":"CentOS","count":1,"path":"api/tags/CentOS.json"},{"name":"Linux","slug":"Linux","count":3,"path":"api/tags/Linux.json"}],"author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}}},"next_post":{"title":"Ubuntu在容器中通过bak文件还原数据库","uid":"09bfaf6dad899e5435cf142c3bc6c1cb","slug":"在容器中通过bak文件还原数据库","date":"2024-11-19T00:00:00.000Z","updated":"2024-12-24T01:56:35.266Z","comments":true,"path":"api/articles/在容器中通过bak文件还原数据库.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/code.m3gmcd1o.webp","text":"在容器中通过bak文件还原数据库1、测试环境需要迁移到另一台虚拟机上时 可以使用nfs的方式获取备份文件，右上角搜索另一篇文章：NFS for CentOS 使...","permalink":"/post/在容器中通过bak文件还原数据库","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[{"name":"Docker","slug":"Docker","count":6,"path":"api/tags/Docker.json"},{"name":"Linux","slug":"Linux","count":3,"path":"api/tags/Linux.json"},{"name":"Ubuntu","slug":"Ubuntu","count":1,"path":"api/tags/Ubuntu.json"},{"name":"数据库","slug":"数据库","count":1,"path":"api/tags/数据库.json"}],"author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}}}}