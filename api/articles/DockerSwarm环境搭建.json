{"title":"DockerSwarm环境搭建","uid":"b41db14a99677b936cf320d0d9be73f1","slug":"DockerSwarm环境搭建","date":"2024-11-18T16:00:00.000Z","updated":"2024-11-29T09:33:04.458Z","comments":true,"path":"api/articles/DockerSwarm环境搭建.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241116/image.7p3mlpbv6a.webp","content":"<h1 id=\"Swarm环境搭建\"><a href=\"#Swarm环境搭建\" class=\"headerlink\" title=\"Swarm环境搭建\"></a><strong>Swarm环境搭建</strong></h1><h2 id=\"系统规划\"><a href=\"#系统规划\" class=\"headerlink\" title=\"系统规划\"></a><strong>系统规划</strong></h2><p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/20241116/image.7p3mlpbv6a.webp\"></p>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a><strong>环境准备</strong></h2><h3 id=\"创建服务器\"><a href=\"#创建服务器\" class=\"headerlink\" title=\"创建服务器\"></a><strong>创建服务器</strong></h3><p>新建三台虚拟机</p>\n<table>\n<thead>\n<tr>\n<th><strong>节点</strong></th>\n<th><strong>IP</strong></th>\n<th><strong>系统</strong></th>\n<th><strong>配置</strong></th>\n<th><strong>存储</strong></th>\n<th><strong>服务</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>manager</td>\n<td>192.168.2.xx</td>\n<td>CentOS7.6</td>\n<td>8U16G</td>\n<td>100G</td>\n<td>redis,frp,mssql</td>\n</tr>\n<tr>\n<td>worker1</td>\n<td>192.168.2.xx</td>\n<td>CentOS7.6</td>\n<td>4U8G</td>\n<td>80G</td>\n<td>app</td>\n</tr>\n<tr>\n<td>worker2</td>\n<td>192.168.2.xx</td>\n<td>CentOS7.6</td>\n<td>4U8G</td>\n<td>80G</td>\n<td>app</td>\n</tr>\n</tbody></table>\n<h3 id=\"时间同步\"><a href=\"#时间同步\" class=\"headerlink\" title=\"时间同步\"></a><strong>时间同步</strong></h3><p>时间同步任务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y ntp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF&gt;&gt;/var/spool/cron/root</span></span><br><span class=\"line\"><span class=\"string\"># 12点同步</span></span><br><span class=\"line\"><span class=\"string\">00 12 * * * /usr/sbin/ntpdate -u ntp1.aliyun.com &amp;&amp; /usr/sbin/hwclock -w</span></span><br><span class=\"line\"><span class=\"string\"># 23：59分执行删除</span></span><br><span class=\"line\"><span class=\"string\">59 23 * * *  docker image prune -af</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##查看计划任务</span></span><br><span class=\"line\">crontab -l</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##手动执行</span></span><br><span class=\"line\">/usr/sbin/ntpdate -u ntp1.aliyun.com &amp;&amp; /usr/sbin/hwclock -w</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a><strong>Docker</strong></h3><h3 id=\"安装Docker\"><a href=\"#安装Docker\" class=\"headerlink\" title=\"安装Docker\"></a><strong>安装Docker</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -sSL http://mirror.dev.gct-china.com/docker/install.sh | sh</span><br></pre></td></tr></table></figure>\n\n<p>启动docker</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl start docker</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl <span class=\"built_in\">enable</span> docker</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"防火墙\"><a href=\"#防火墙\" class=\"headerlink\" title=\"防火墙\"></a><strong>防火墙</strong></h3><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>Error response from daemon: rpc error: code &#x3D; Unavailable desc &#x3D; connection error: desc &#x3D; “transport: Error while dialing dial tcp 192.168.2.61:2377: connect: no route to host”</p></blockquote>\n<p><strong>打开防火墙</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># manager</span></span><br><span class=\"line\">firewall-cmd --zone=public --add-port=2377/tcp --permanent</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 所有node</span></span><br><span class=\"line\">firewall-cmd --zone=public --add-port=7946/tcp --permanent</span><br><span class=\"line\">firewall-cmd --zone=public --add-port=7946/udp --permanent</span><br><span class=\"line\">firewall-cmd --zone=public --add-port=4789/tcp --permanent</span><br><span class=\"line\">firewall-cmd --zone=public --add-port=4789/udp --permanent</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 所有node</span></span><br><span class=\"line\">firewall-cmd --reload</span><br><span class=\"line\">systemctl restart docker</span><br></pre></td></tr></table></figure>\n\n<p>要在 swarm 集群中使用使用路由网格，首先需要开启加入swarm集群的节点的以下端口：</p>\n<ul>\n<li><code>2377</code> ：主节点监听端口</li>\n<li><code>7946</code> ：容器网络发现</li>\n<li><code>4789</code> ：容器网络入口</li>\n</ul>\n<h2 id=\"Swarm\"><a href=\"#Swarm\" class=\"headerlink\" title=\"Swarm\"></a><strong>Swarm</strong></h2><h3 id=\"创建Swarm\"><a href=\"#创建Swarm\" class=\"headerlink\" title=\"创建Swarm\"></a><strong>创建Swarm</strong></h3><p>创建<strong>Swarm</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker swarm init --advertise-addr your_manager_ip</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/20241116/image.4ckwrbw4h6.webp\"></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@manager ~]# docker swarm init --advertise-addr 192.168.2.61</span><br><span class=\"line\">Swarm initialized: current node (rzds6oyb0bgvudzegpscmgiz3) is now a manager.</span><br><span class=\"line\"></span><br><span class=\"line\">To add a worker to this swarm, run the following <span class=\"built_in\">command</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">    docker swarm <span class=\"built_in\">join</span> --token SWMTKN-1-51b7t8whxn8j6mdjt5perjmec9u8qguxq8tern9nill737pra2-ejc5nw5f90oz6xldcbmrl2ztu 192.168.2.61:2377</span><br><span class=\"line\"></span><br><span class=\"line\">To add a manager to this swarm, run <span class=\"string\">&#x27;docker swarm join-token manager&#x27;</span> and follow the instructions.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"加入Swarm\"><a href=\"#加入Swarm\" class=\"headerlink\" title=\"加入Swarm\"></a><strong>加入Swarm</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker swarm <span class=\"built_in\">join</span> --token SWMTKN-1-51b7t8whxn8j6mdjt5perjmec9u8qguxq8tern9nill737pra2-ejc5nw5f90oz6xldcbmrl2ztu 192.168.2.61:2377</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/20241116/image.58he6s6ao3.webp\"></p>\n<h3 id=\"查看节点\"><a href=\"#查看节点\" class=\"headerlink\" title=\"查看节点\"></a><strong>查看节点</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@manager ~]# docker node <span class=\"built_in\">ls</span></span><br><span class=\"line\">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class=\"line\">rzds6oyb0bgvudzegpscmgiz3 *   manager    Ready     Active         Leader           20.10.17</span><br><span class=\"line\">rjj3fr5uazywwsfj6ok3f3fw3     worker1    Ready     Active                          20.10.17</span><br><span class=\"line\">6vkvdm3gcxip8htc6cfk8bm3n     worker2    Ready     Active                          20.10.17</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"服务约束\"><a href=\"#服务约束\" class=\"headerlink\" title=\"服务约束\"></a><strong>服务约束</strong></h3><p>添加<strong>label</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> docker node update --label-add role=<span class=\"built_in\">env</span> manager</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> docker node update --label-add gct_medpro=gct_medpro zhuji</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/20241116/image.175ese2p1f.webp\"></p>\n<p>给节点也加上</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@manager ~]# <span class=\"built_in\">sudo</span> docker node update --label-add role=app worker1</span><br><span class=\"line\">worker1</span><br><span class=\"line\">[root@manager ~]# <span class=\"built_in\">sudo</span> docker node update --label-add role=app worker2</span><br><span class=\"line\">worker2</span><br></pre></td></tr></table></figure>\n","text":"Swarm环境搭建系统规划 环境准备创建服务器新建三台虚拟机 节点 IP 系统 配置 存储 服务 manager 192.168.2.xx CentOS7.6 ...","permalink":"/post/DockerSwarm环境搭建","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[{"name":"Docker","slug":"Docker","count":6,"path":"api/tags/Docker.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Swarm%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">Swarm环境搭建</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%92\"><span class=\"toc-text\">系统规划</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87\"><span class=\"toc-text\">环境准备</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E5%99%A8\"><span class=\"toc-text\">创建服务器</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5\"><span class=\"toc-text\">时间同步</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Docker\"><span class=\"toc-text\">Docker</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85Docker\"><span class=\"toc-text\">安装Docker</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%98%B2%E7%81%AB%E5%A2%99\"><span class=\"toc-text\">防火墙</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Swarm\"><span class=\"toc-text\">Swarm</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BASwarm\"><span class=\"toc-text\">创建Swarm</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8A%A0%E5%85%A5Swarm\"><span class=\"toc-text\">加入Swarm</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9\"><span class=\"toc-text\">查看节点</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9C%8D%E5%8A%A1%E7%BA%A6%E6%9D%9F\"><span class=\"toc-text\">服务约束</span></a></li></ol></li></ol></li></ol>","author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"Ubuntu在容器中通过bak文件还原数据库","uid":"09bfaf6dad899e5435cf142c3bc6c1cb","slug":"在容器中通过bak文件还原数据库","date":"2024-11-19T00:00:00.000Z","updated":"2024-12-24T01:56:35.266Z","comments":true,"path":"api/articles/在容器中通过bak文件还原数据库.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/code.m3gmcd1o.webp","text":"在容器中通过bak文件还原数据库1、测试环境需要迁移到另一台虚拟机上时 可以使用nfs的方式获取备份文件，右上角搜索另一篇文章：NFS for CentOS 使...","permalink":"/post/在容器中通过bak文件还原数据库","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[{"name":"Docker","slug":"Docker","count":6,"path":"api/tags/Docker.json"},{"name":"Linux","slug":"Linux","count":3,"path":"api/tags/Linux.json"},{"name":"Ubuntu","slug":"Ubuntu","count":1,"path":"api/tags/Ubuntu.json"},{"name":"数据库","slug":"数据库","count":1,"path":"api/tags/数据库.json"}],"author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}}},"next_post":{"title":"Ubuntu一键安装卸载docker和dockercompose","uid":"fec2c7ee16664a58fd23e5c35dbd3596","slug":"Ubuntu一键安装卸载docker","date":"2024-11-18T16:00:00.000Z","updated":"2024-11-30T04:34:27.681Z","comments":true,"path":"api/articles/Ubuntu一键安装卸载docker.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/docker.4g4ilvor9o.webp","text":"在新建的服务器上，我们一般会用几条命令来下载安装docker和docker-compose，这里为了避免每次都去搜索安装命令，所以写成脚本，本文仅支持Ubunt...","permalink":"/post/Ubuntu一键安装卸载docker","photos":[],"count_time":{"symbolsCount":"9.4k","symbolsTime":"9 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[],"author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}},"feature":true}}