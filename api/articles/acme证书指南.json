{"title":"acme证书指南","uid":"2fa7613b39e74fc504fcd245fd9c9634","slug":"acme证书指南","date":"2024-11-28T00:00:00.000Z","updated":"2024-12-24T01:56:35.264Z","comments":true,"path":"api/articles/acme证书指南.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241115/image.6m3x9kfoen.webp","content":"<p>通常我们自己的网站比如博客、个人网站、小程序等都需要使用SSL证书来确保安全。但是申请证书并不是一件简单的事情，需要有一定的经验和知识。本文将介绍如何使用acme.sh来自动申请和续期SSL证书。</p>\n<h2 id=\"什么是acme？\"><a href=\"#什么是acme？\" class=\"headerlink\" title=\"什么是acme？\"></a>什么是acme？</h2><p>acme（Automatic Certificate Management Environment，自动证书管理环境）是一个开源的证书颁发机构（CA）软件，它可以自动为网站、服务提供证书。</p>\n<h3 id=\"acme的工作原理\"><a href=\"#acme的工作原理\" class=\"headerlink\" title=\"acme的工作原理\"></a>acme的工作原理</h3><p>acme的工作原理是，当用户访问网站或服务时，如果网站或服务的证书已经过期，则acme会向证书颁发机构（CA）请求证书。CA会对用户的身份信息进行验证，并签发证书。acme会自动安装并更新证书。</p>\n<h3 id=\"证书的类型\"><a href=\"#证书的类型\" class=\"headerlink\" title=\"证书的类型\"></a>证书的类型</h3><p>acme支持多种证书类型，包括：</p>\n<ul>\n<li>RSA证书：最常用的证书类型，由RSA算法生成的证书，安全性较高。</li>\n<li>ECC证书：由椭圆曲线算法生成的证书，安全性较高。</li>\n<li>多域名证书：可以为多个域名生成证书，可以有效防止域名劫持。</li>\n<li>通配符证书：可以为多个子域名生成证书，可以有效防止泛域名证书被攻击。</li>\n<li>自签名证书：可以为网站或服务提供自签名证书，可以有效防止证书被篡改。</li>\n</ul>\n<h3 id=\"acme的常用命令\"><a href=\"#acme的常用命令\" class=\"headerlink\" title=\"acme的常用命令\"></a>acme的常用命令</h3><p>acme的常用命令有：</p>\n<ul>\n<li><code>acme.sh --issue -d example.com -w /path/to/webroot</code>：签发example.com的证书，并将证书安装到&#x2F;path&#x2F;to&#x2F;webroot目录。</li>\n<li><code>acme.sh --renew -d example.com -w /path/to/webroot</code>：续期example.com的证书，并将证书安装到&#x2F;path&#x2F;to&#x2F;webroot目录。</li>\n<li><code>acme.sh --revoke -d example.com</code>：吊销example.com的证书。</li>\n<li><code>acme.sh --install-cert -d example.com -w /path/to/webroot</code>：安装example.com的证书到&#x2F;path&#x2F;to&#x2F;webroot目录。</li>\n<li><code>acme.sh --update-account-key</code>：更新acme账户的私钥。</li>\n<li><code>acme.sh --upgrade</code>：升级acme到最新版本。</li>\n</ul>\n<p>参考：<a href=\"https://github.com/Neilpang/acme.sh/wiki\">acme.sh 官方文档</a></p>\n<h2 id=\"颁发证书\"><a href=\"#颁发证书\" class=\"headerlink\" title=\"颁发证书\"></a>颁发证书</h2><h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><div class=\"custom-quote danger\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M19.76 5.23C15.84 5.23 12 2 12 2C12 2 8.15996 5.23 4.23996 5.23C4.23996 5.23 1.86996 16.99 12 22C22.13 16.99 19.76 5.23 19.76 5.23Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 16H12\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">购买域名和服务器</p>\n<ul>\n<li>准备服务器（云服务器或自建服务器）<ol>\n<li>服务器需要安装docker和docker-compose，这里我用的是v2版本的docker-compose语法。</li>\n<li>服务器需要开放80和443端口</li>\n</ol>\n</li>\n<li>准备域名<ol>\n<li>购买域名，并将域名解析到服务器的IP地址。</li>\n</ol>\n</li>\n</ul>\n\n</div>\n<p>如果不会请百度或者看我的其他文章，这里不再赘述。</p>\n<h3 id=\"安装acme-sh和nginx\"><a href=\"#安装acme-sh和nginx\" class=\"headerlink\" title=\"安装acme.sh和nginx\"></a>安装acme.sh和nginx</h3><details class=\"custom-details\">\n<summary>acme用来自动签发证书，nginx用来配置证书的安装。</summary>\n<p><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: &#x27;3.8&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">services:</span><br><span class=\"line\">  nginx:</span><br><span class=\"line\">    container_name: nginx</span><br><span class=\"line\">    image: nginx</span><br><span class=\"line\">    restart: always</span><br><span class=\"line\">    network_mode: host</span><br><span class=\"line\">    logging:</span><br><span class=\"line\">      options:</span><br><span class=\"line\">        max-size: &#x27;2048m&#x27;</span><br><span class=\"line\">        max-file: &#x27;10&#x27;</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      - nginx</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - /docker/nginx/acme/d1:/domains</span><br><span class=\"line\">      - /docker/nginx/conf.d:/etc/nginx/conf.d</span><br><span class=\"line\">      - /docker/nginx/nginx.conf:/etc/nginx/nginx.conf</span><br><span class=\"line\">      - /docker/nginx/www:/var/www</span><br><span class=\"line\">      - /root/static_website:/static_website</span><br><span class=\"line\"></span><br><span class=\"line\">  acme.sh:</span><br><span class=\"line\">    container_name: acme.sh</span><br><span class=\"line\">    image: neilpang/acme.sh:3.0.5</span><br><span class=\"line\">    restart: always</span><br><span class=\"line\">    command: daemon</span><br><span class=\"line\">    logging:</span><br><span class=\"line\">      options:</span><br><span class=\"line\">        max-size: &#x27;2048m&#x27;</span><br><span class=\"line\">        max-file: &#x27;10&#x27;</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      # 挂载主机路径到容器路径，用于保存acme.sh脚本</span><br><span class=\"line\">      - /docker/nginx/acme:/acme.sh</span><br><span class=\"line\">      # 挂载主机路径到容器路径，允许容器通过docker.sock与本地docker服务通信</span><br><span class=\"line\">      - /var/run/docker.sock:/var/run/docker.sock</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      # 设置容器的部署标签，用于自动加载与nginx相关的配置</span><br><span class=\"line\">      - DEPLOY_DOCKER_CONTAINER_LABEL=nginx</span><br><span class=\"line\">      # 设置容器的自动重载命令，在容器发生变化时执行该命令重新加载nginx配置</span><br><span class=\"line\">      - DEPLOY_DOCKER_CONTAINER_RELOAD_CMD=&quot;service nginx force-reload&quot;</span><br><span class=\"line\">      # 设置阿里云的Access Key</span><br><span class=\"line\">      - Ali_Key=********</span><br><span class=\"line\">      # 设置阿里云的Secret Key</span><br><span class=\"line\">      - Ali_Secret=************</span><br><span class=\"line\">      # 设置华为云的用户名</span><br><span class=\"line\">      - HUAWEICLOUD_Username=********</span><br><span class=\"line\">      # 设置华为云的密钥</span><br><span class=\"line\">      - HUAWEICLOUD_Password=*********</span><br><span class=\"line\">      # 设置华为云的域名</span><br><span class=\"line\">      - HUAWEICLOUD_DomainName=********</span><br></pre></td></tr></table></figure>\n\n</p>\n</details>\n<h3 id=\"签发证书\"><a href=\"#签发证书\" class=\"headerlink\" title=\"签发证书\"></a>签发证书</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//阿里云解析：dns_ali  </span><br><span class=\"line\">//华为云解析：dns_huaweicloud</span><br><span class=\"line\">sudo docker exec \\</span><br><span class=\"line\"> acme --issue --dns dns_ali \\</span><br><span class=\"line\"> -d example.com \\</span><br><span class=\"line\"> --cert-file\t    /acme.sh/domains/example.com/cert.cert \\</span><br><span class=\"line\"> --key-file         /acme.sh/domains/example.com/key.key \\</span><br><span class=\"line\"> --ca-file          /acme.sh/domains/example.com/ca.cer \\</span><br><span class=\"line\"> --fullchain-file   /acme.sh/domains/example.com/fullchain.pem \\</span><br><span class=\"line\"> --force</span><br><span class=\"line\"></span><br><span class=\"line\">//example.com为域名</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"自动化续签\"><a href=\"#自动化续签\" class=\"headerlink\" title=\"自动化续签\"></a>自动化续签</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker exec acme.sh  --upgrade  --auto-upgrade</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"重载配置\"><a href=\"#重载配置\" class=\"headerlink\" title=\"重载配置\"></a>重载配置</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker exec -it nginx  service nginx force-reload</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"nignx配置\"><a href=\"#nignx配置\" class=\"headerlink\" title=\"nignx配置\"></a>nignx配置</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">error_log /var/log/nginx/error.log;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    listen 443 ssl;</span><br><span class=\"line\">    server_name example.com;</span><br><span class=\"line\">    ssl_protocols TLSv1.2 TLSv1.1 TLSv1; </span><br><span class=\"line\">  </span><br><span class=\"line\">    ssl_certificate      /domains/fullchain.pem; //证书路径</span><br><span class=\"line\">    ssl_certificate_key  /domains/key.key; //密钥路径</span><br><span class=\"line\">    ssl_prefer_server_ciphers on; </span><br><span class=\"line\">    ssl_session_timeout  5m;</span><br><span class=\"line\">    if ($server_port = 80) &#123;</span><br><span class=\"line\">    rewrite ^(.*)$ https://$host$1 permanent;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass ip地址加端口号;</span><br><span class=\"line\">        proxy_set_header Host $host;</span><br><span class=\"line\">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">        root /home/web/;</span><br><span class=\"line\">        index index.php;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"重启nginx\"><a href=\"#重启nginx\" class=\"headerlink\" title=\"重启nginx\"></a>重启nginx</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker restart nginx</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"完结\"><a href=\"#完结\" class=\"headerlink\" title=\"完结\"></a>完结</h2><p>至此，acme证书申请和续期的流程已经介绍完毕，访问自己的网站或服务时你会看到https的锁，如果证书已经过期，则会自动申请和安装证书。</p>\n","feature":true,"text":"通常我们自己的网站比如博客、个人网站、小程序等都需要使用SSL证书来确保安全。但是申请证书并不是一件简单的事情，需要有一定的经验和知识。本文将介绍如何使用acm...","permalink":"/post/acme证书指南","photos":[],"count_time":{"symbolsCount":"3.9k","symbolsTime":"4 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[{"name":"SSL","slug":"SSL","count":1,"path":"api/tags/SSL.json"},{"name":"Liunx","slug":"Liunx","count":1,"path":"api/tags/Liunx.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%80%E4%B9%88%E6%98%AFacme%EF%BC%9F\"><span class=\"toc-text\">什么是acme？</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#acme%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86\"><span class=\"toc-text\">acme的工作原理</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%AF%81%E4%B9%A6%E7%9A%84%E7%B1%BB%E5%9E%8B\"><span class=\"toc-text\">证书的类型</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#acme%E7%9A%84%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4\"><span class=\"toc-text\">acme的常用命令</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6\"><span class=\"toc-text\">颁发证书</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\"><span class=\"toc-text\">准备工作</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85acme-sh%E5%92%8Cnginx\"><span class=\"toc-text\">安装acme.sh和nginx</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6\"><span class=\"toc-text\">签发证书</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%AD%E7%AD%BE\"><span class=\"toc-text\">自动化续签</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">重载配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#nignx%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">nignx配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%87%8D%E5%90%AFnginx\"><span class=\"toc-text\">重启nginx</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%8C%E7%BB%93\"><span class=\"toc-text\">完结</span></a></li></ol>","author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"Docker构建、打包、部署一条龙的过程","uid":"32b006c2c9398b6cfeebb21599635996","slug":"构建DockerFile","date":"2024-11-29T10:07:43.764Z","updated":"2024-11-29T10:19:45.366Z","comments":true,"path":"api/articles/构建DockerFile.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/11/image_be798dfabff7c30454f5233b1dc68c5f.png","text":"Web项目写好后，我习惯用Docker打包成镜像然后部署到服务器上使用，理由是方便，后面迭代的时候只需要更换镜像就能完成部署，甚至更方便点使用cicd完成自动化...","permalink":"/post/构建DockerFile","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[{"name":"Docker","slug":"Docker","count":6,"path":"api/tags/Docker.json"}],"author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}},"feature":true},"next_post":{"title":"我在人间凑数的第8865天","uid":"2f6f4322594661f0414df8fc201523ed","slug":"2024.12.24日常小记","date":"2024-12-24T01:56:11.053Z","updated":"2024-12-24T01:56:20.909Z","comments":true,"path":"api/articles/2024.12.24日常小记.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/12/image_486ded1f771e374c316e9da3db6c0b2e.png","text":"随便叭叭有时候想成为一个有思想深度的人，但奈何读书太少没啥文化，看书于我而言跟催眠无差别，于是我放弃🙄 。 最近喜欢一个泰国女演员Orm，她身上蓬勃的生命力和明...","permalink":"/post/2024.12.24日常小记","photos":[],"count_time":{"symbolsCount":304,"symbolsTime":"1 mins."},"categories":[{"name":"日常","slug":"日常","count":2,"path":"api/categories/日常.json"}],"tags":[{"name":"杂谈","slug":"杂谈","count":1,"path":"api/tags/杂谈.json"}],"author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}},"feature":false}}