{"title":"GitHubAction实现自动化部署","uid":"c63101490a44e6dea3cd9d49ca1e518b","slug":"GitHubAction实现自动化部署","date":"2024-12-02T09:48:38.957Z","updated":"2024-12-03T03:16:40.945Z","comments":true,"path":"api/articles/GitHubAction实现自动化部署.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/12/image_3e28891b15f3fa786083895f3951ec21.png","content":"<p>由于我的服务器配置太低支持不了GitLab的CICD，所以我这里用GitHub Action来实现（感恩），上期我们说到docker官方镜像仓库即使你用代理也经常出现拉不下来的情况，所以我们可以换个思路，把镜像发布到阿里云的个人仓库，或者自己建一个docker私有镜像仓库，本着白嫖原则，本文使用阿里云私有镜像仓库服务。</p>\n<h1 id=\"开通阿里云私有镜像仓库\"><a href=\"#开通阿里云私有镜像仓库\" class=\"headerlink\" title=\"开通阿里云私有镜像仓库\"></a>开通阿里云私有镜像仓库</h1><h2 id=\"登录：阿里云镜像服务\"><a href=\"#登录：阿里云镜像服务\" class=\"headerlink\" title=\"登录：阿里云镜像服务\"></a>登录：<a href=\"https://cr.console.aliyun.com/\">阿里云镜像服务</a></h2><h2 id=\"启用个人实例\"><a href=\"#启用个人实例\" class=\"headerlink\" title=\"启用个人实例\"></a>启用个人实例</h2><p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/12/image_05d144711d73140e245e144811ed767a.png\"></p>\n<h2 id=\"创建一个命名空间，并且设为公开（可以不用登陆直接拉镜像）\"><a href=\"#创建一个命名空间，并且设为公开（可以不用登陆直接拉镜像）\" class=\"headerlink\" title=\"创建一个命名空间，并且设为公开（可以不用登陆直接拉镜像）\"></a>创建一个命名空间，并且设为公开（可以不用登陆直接拉镜像）</h2><p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/12/image_b8ce5fe748d3bfcec96564d93c4dc54c.png\"></p>\n<h2 id=\"创建好后去Github仓库设置环境变量\"><a href=\"#创建好后去Github仓库设置环境变量\" class=\"headerlink\" title=\"创建好后去Github仓库设置环境变量\"></a>创建好后去Github仓库设置环境变量</h2><p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/12/image_3ac14204130273655d95f93935a611df.png\"></p>\n<p>这里云服务器要开放22端口，确保&#x2F;etc&#x2F;ssh&#x2F;sshd_config的配置如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 如果是root登录，则配置</span><br><span class=\"line\">PermitRootLogin yes</span><br><span class=\"line\"># 允许密码登录</span><br><span class=\"line\">PasswordAuthentication yes</span><br><span class=\"line\"># 如果使用密钥登录，则配置</span><br><span class=\"line\">PubkeyAuthentication yes</span><br></pre></td></tr></table></figure>\n\n<p>配置后使用<code>sudo systemctl restart sshd</code>生效</p>\n<p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/12/image_1d27cd1a68f34e66a1e1dfd895c600d2.png\"></p>\n<p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/12/image_ee1277599379d883f28293933b512f5d.png\"></p>\n<h1 id=\"构建GitHubAction\"><a href=\"#构建GitHubAction\" class=\"headerlink\" title=\"构建GitHubAction\"></a>构建GitHubAction</h1><p>文件目录如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Directory: D:\\Project\\Demos</span><br><span class=\"line\"></span><br><span class=\"line\">Mode                 LastWriteTime         Length Name</span><br><span class=\"line\">----                 -------------         ------ ----</span><br><span class=\"line\">d----           2024/12/2    11:13                .github</span><br><span class=\"line\">d----           2024/12/2    11:13                .vscode</span><br><span class=\"line\">d----           2024/12/2    11:13                src</span><br><span class=\"line\">-a---           2024/12/2    15:45            549 .gitignore  </span><br><span class=\"line\">-a---           2024/12/2    16:14            270 docker-compose.yml</span><br><span class=\"line\">-a---           2024/11/1    13:45             27 README.md</span><br></pre></td></tr></table></figure>\n\n<p>我的Dockerfile文件放在src下面，创建deploy.yml放在.github&#x2F;workflows，内容如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">Build</span> <span class=\"string\">and</span> <span class=\"string\">Deploy</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">on:</span></span><br><span class=\"line\">  <span class=\"comment\"># 当代码被推送到仓库时触发</span></span><br><span class=\"line\">  <span class=\"attr\">push:</span></span><br><span class=\"line\">    <span class=\"attr\">branches:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">main</span>  <span class=\"comment\"># 可以根据需要更改为你的目标分支</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"comment\"># 构建和推送 Docker 镜像</span></span><br><span class=\"line\">  <span class=\"attr\">build:</span></span><br><span class=\"line\">    <span class=\"comment\"># 在哪个环境下运行</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"comment\"># 检查代码</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Checkout</span> <span class=\"string\">code</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 安装 Docker 构建工具</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Set</span> <span class=\"string\">up</span> <span class=\"string\">Docker</span> <span class=\"string\">Buildx</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">docker/setup-buildx-action@v2</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 登录到阿里云 Docker 镜像仓库</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Log</span> <span class=\"string\">in</span> <span class=\"string\">to</span> <span class=\"string\">Alibaba</span> <span class=\"string\">Cloud</span> <span class=\"string\">Docker</span> <span class=\"string\">Registry</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">docker/login-action@v2</span></span><br><span class=\"line\">      <span class=\"attr\">with:</span></span><br><span class=\"line\">        <span class=\"attr\">username:</span> <span class=\"string\">$&#123;&#123;secrets.ALIYUN_REGISTRY_USER&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">password:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.ALIYUN_REGISTRY_PASSWORD</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">registry:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.ALIYUN_REGISTRY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 构建并推送 Docker 镜像</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Build</span> <span class=\"string\">and</span> <span class=\"string\">push</span> <span class=\"string\">Docker</span> <span class=\"string\">image</span></span><br><span class=\"line\">      <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        docker build -t $&#123;&#123; secrets.ALIYUN_REGISTRY &#125;&#125;/$&#123;&#123; secrets.ALIYUN_NAME_SPACE &#125;&#125;/$&#123;&#123; secrets.IMAGE_NAME &#125;&#125;:latest ./src</span></span><br><span class=\"line\"><span class=\"string\">        docker push $&#123;&#123; secrets.ALIYUN_REGISTRY &#125;&#125;/$&#123;&#123; secrets.ALIYUN_NAME_SPACE &#125;&#125;/$&#123;&#123; secrets.IMAGE_NAME &#125;&#125;:latest</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"attr\">deploy:</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">needs:</span> <span class=\"string\">build</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">production</span></span><br><span class=\"line\">      <span class=\"attr\">url:</span> <span class=\"string\">https://xxxx</span></span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"comment\"># 检查代码</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Checkout</span> <span class=\"string\">code</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\">      <span class=\"comment\"># SSH 连接到服务器并部署应用</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SSH</span> <span class=\"string\">into</span> <span class=\"string\">server</span> <span class=\"string\">and</span> <span class=\"string\">deploy</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">appleboy/ssh-action@v0.1.8</span></span><br><span class=\"line\">      <span class=\"attr\">with:</span></span><br><span class=\"line\">        <span class=\"attr\">host:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.ALIYUN_SERVER_IP</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">username:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.ALIYUN_SERVER_USER</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">password:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.ALIYUN_SERVER_PASSWORD</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">port:</span> <span class=\"number\">22</span></span><br><span class=\"line\">        <span class=\"comment\"># 如果使用私钥登录则打开下列配置</span></span><br><span class=\"line\">        <span class=\"comment\"># key: $&#123;&#123; secrets.SSH_PRIVATE_KEY &#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">script:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">          # 拉取镜像</span></span><br><span class=\"line\"><span class=\"string\">          docker pull $&#123;&#123; secrets.ALIYUN_REGISTRY &#125;&#125;/$&#123;&#123; secrets.ALIYUN_NAME_SPACE &#125;&#125;/$&#123;&#123; secrets.IMAGE_NAME &#125;&#125;:latest</span></span><br><span class=\"line\"><span class=\"string\">          # 停止之前的容器</span></span><br><span class=\"line\"><span class=\"string\">          docker stop $&#123;&#123; secrets.IMAGE_NAME &#125;&#125; || true</span></span><br><span class=\"line\"><span class=\"string\">          docker rm $&#123;&#123; secrets.IMAGE_NAME &#125;&#125; || true</span></span><br><span class=\"line\"><span class=\"string\">          # 启动容器</span></span><br><span class=\"line\"><span class=\"string\">          docker run -d --name $&#123;&#123; secrets.IMAGE_NAME &#125;&#125; -p 7121:80 $&#123;&#123; secrets.ALIYUN_REGISTRY &#125;&#125;/$&#123;&#123; secrets.ALIYUN_NAME_SPACE &#125;&#125;/$&#123;&#123; secrets.IMAGE_NAME &#125;&#125;:latest</span></span><br></pre></td></tr></table></figure>\n\n<p>配置完推送分支就可以啦！</p>\n<p><img src=\"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/12/image_6c39d5c4d0efdbb7bde338c206e07587.png\"></p>\n","feature":true,"text":"由于我的服务器配置太低支持不了GitLab的CICD，所以我这里用GitHub Action来实现（感恩），上期我们说到docker官方镜像仓库即使你用代理也经...","permalink":"/post/GitHubAction实现自动化部署","photos":[],"count_time":{"symbolsCount":"3.5k","symbolsTime":"3 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[{"name":"CICD","slug":"CICD","count":1,"path":"api/tags/CICD.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%BC%80%E9%80%9A%E9%98%BF%E9%87%8C%E4%BA%91%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93\"><span class=\"toc-text\">开通阿里云私有镜像仓库</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%99%BB%E5%BD%95%EF%BC%9A%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">登录：阿里云镜像服务</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%90%AF%E7%94%A8%E4%B8%AA%E4%BA%BA%E5%AE%9E%E4%BE%8B\"><span class=\"toc-text\">启用个人实例</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%AE%BE%E4%B8%BA%E5%85%AC%E5%BC%80%EF%BC%88%E5%8F%AF%E4%BB%A5%E4%B8%8D%E7%94%A8%E7%99%BB%E9%99%86%E7%9B%B4%E6%8E%A5%E6%8B%89%E9%95%9C%E5%83%8F%EF%BC%89\"><span class=\"toc-text\">创建一个命名空间，并且设为公开（可以不用登陆直接拉镜像）</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA%E5%A5%BD%E5%90%8E%E5%8E%BBGithub%E4%BB%93%E5%BA%93%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F\"><span class=\"toc-text\">创建好后去Github仓库设置环境变量</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%9E%84%E5%BB%BAGitHubAction\"><span class=\"toc-text\">构建GitHubAction</span></a></li></ol>","author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}},"mapped":true,"hidden":false,"prev_post":{},"next_post":{"title":"Docker构建、打包、部署一条龙的过程","uid":"32b006c2c9398b6cfeebb21599635996","slug":"构建DockerFile","date":"2024-11-29T10:07:43.764Z","updated":"2024-11-29T10:19:45.366Z","comments":true,"path":"api/articles/构建DockerFile.json","keywords":null,"cover":"https://github.com/faceman0814/picx-images-hosting/raw/master/Qexo/24/11/image_be798dfabff7c30454f5233b1dc68c5f.png","text":"Web项目写好后，我习惯用Docker打包成镜像然后部署到服务器上使用，理由是方便，后面迭代的时候只需要更换镜像就能完成部署，甚至更方便点使用cicd完成自动化...","permalink":"/post/构建DockerFile","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"DevOps","slug":"DevOps","count":11,"path":"api/categories/DevOps.json"}],"tags":[{"name":"Docker","slug":"Docker","count":6,"path":"api/tags/Docker.json"}],"author":{"name":"FaceMan","slug":"blog-author","avatar":"https://github.com/faceman0814/picx-images-hosting/raw/master/20241114/image.2vermeukr5.webp","link":"/","description":"从0开始，直到1。","socials":{"github":"https://github.com/faceman0814","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/manmanzainuli","juejin":"","customs":{"bokeyuan":{"icon":"/svg/bokeyuan.svg","link":"https://www.cnblogs.com/FaceMan"}}}},"feature":true}}